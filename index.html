<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Subnautica GeoGuessr</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body {
    margin: 0;
    color: #00ffff;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    overflow-x: hidden;
    background: url("Background/DashboardBackground.png") no-repeat center center fixed;
    background-size: cover;
    position: relative;
    transition: background-image 0.5s ease-in-out;
  }
  body::before {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(10, 15, 20, 0.75);
    z-index: 0;
  }
  * { position: relative; z-index: 1; }

  header { margin-top: 10px; text-align: center; cursor: pointer; user-select: none; transition: color 0.3s; }
  h1 { font-size: 2.5rem; margin-bottom: 10px; transition: color 0.3s, transform 0.3s; }
  h1:hover { color: #00cccc; transform: scale(1.03); }
  p { margin-bottom: 10px; }

  .username-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
  #username-input {
    background: #0a1a20cc;
    border: 2px solid #00ffff;
    border-radius: 10px;
    color: #00ffff;
    padding: 10px 15px;
    font-size: 1rem;
    width: 200px;
    text-align: center;
    outline: none;
    transition: all 0.3s ease;
  }
  #username-input:focus { box-shadow: 0 0 12px #00ffff; }

  #credits-btn {
    background: none;
    border: 2px solid #00ffff;
    color: #00ffff;
    font-size: 1rem;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.3s;
  }
  #credits-btn:hover { background: #00ffff; color: #0a0f14; transform: scale(1.05); }

  .gamemode-container { margin-top: 20px; display: flex; flex-direction: column; gap: 20px; max-width: 1200px; opacity: 1; transition: opacity 0.5s ease; }
  .gamemode-row { display: flex; justify-content: center; gap: 25px; }

  .gamemode-card {
    border: 2px solid #00ffff; border-radius: 15px; padding: 20px;
    width: 220px; height: 70px; text-align: center;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.15);
    cursor: pointer; transition: all 0.25s ease;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem; font-weight: bold; color: #00ffff;
    background-size: cover; background-position: center;
    text-shadow: 0 0 6px #000, 0 0 10px #000;
  }
  .gamemode-card:hover { transform: scale(1.07); box-shadow: 0 0 25px rgba(0, 255, 255, 0.35); background-color: #0e1b22cc; }

  .entire-map {
    margin-top: 40px; width: 80%; max-width: 600px;
    background: radial-gradient(circle at center, #00ffff55, #00ffff22 80%);
    border: 3px solid #00ffff; color: #00ffff; border-radius: 25px;
    padding: 40px 0; font-size: 1.8rem; letter-spacing: 1px; font-weight: bold;
    cursor: pointer; text-align: center; transition: all 0.4s ease;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.25); margin-bottom: 15px;
  }
  .entire-map:hover { transform: scale(1.05); box-shadow: 0 0 60px rgba(0, 255, 255, 0.6); background: radial-gradient(circle at center, #00ffff88, #00ffff33 80%); color: #0a0f14; }

  .leaderboard, .credits {
    display: none; flex-direction: column; align-items: center;
    margin-top: 40px; background-color: #112029cc; border: 2px solid #00ffff;
    border-radius: 15px; padding: 20px; width: 500px; text-align: center;
    opacity: 0; transform: scale(0.98); transition: opacity 0.5s ease, transform 0.5s ease;
  }
  .leaderboard.active, .credits.active { display: flex; opacity: 1; transform: scale(1); }

  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border-bottom: 1px solid #00ffff; padding: 8px; }
  th { color: #00ffff; } td { color: white; }

  .mode-buttons { display: flex; justify-content: center; gap: 15px; align-items: center; margin-bottom: 15px; }
  .mode-btn { border: 2px solid #00ffff; color: #00ffff; background: none; font-size: 1.1rem; font-weight: bold; padding: 8px 15px; border-radius: 10px; cursor: pointer; transition: 0.3s; }
  .mode-btn:hover, .mode-btn.active { background: #00ffff; color: #0a0f14; transform: scale(1.05); }

  .play-btn { background-color: #00ffff; border: none; color: #0a0f14; font-size: 1.1rem; font-weight: bold; padding: 8px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
  .play-btn:hover { transform: scale(1.05); box-shadow: 0 0 12px #00ffff; }
</style>
</head>
<body>
<header onclick="returnToDashboard()">
  <h1>Subnautica GeoGuessr</h1>
  <p>Dive Into the Depths and Test Your Location Knowledge | Please Set a Username Below</p>
  <div class="username-container">
    <input id="username-input" type="text" placeholder="Enter username" />
    <button id="credits-btn" onclick="showCredits(event)">Credits</button>
  </div>
</header>

<div class="gamemode-container" id="gamemode-container"></div>

<button class="entire-map" onclick="showLeaderboard({ display: 'Entire Map', key: manualKeys['Entire Map'] })">üåç Play the Entire Subnautica Map üåç</button>

<div class="leaderboard" id="leaderboard">
  <h2 id="selected-mode-title">üèÜ Leaderboard</h2>
  <div class="mode-buttons">
    <button class="mode-btn active" id="normal-btn">Normal Image</button>
    <button class="mode-btn" id="mode360-btn">360 Image</button>
    <button class="play-btn" id="play-btn">Play</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Rank</th><th>Username</th><th>Score</th><th>Time</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>
</div>

<div class="credits" id="credits">
  <h2>Credits</h2>
  <p>Placeholder for your credits. You can add contributors, asset sources, and acknowledgements here.</p>
  <button class="play-btn" onclick="returnToDashboard()">‚Üê Back</button>
</div>

<script>
const SUPABASE_URL = "https://ayasirbxjxwslknhbsvn.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5YXNpcmJ4anh3c2xrbmhic3ZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMjY1ODcsImV4cCI6MjA3NTYwMjU4N30.5E-ffTjzZ4pxkubtcBINHh_Jw9d6vltDs1kH8aAqB60";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const toKey = (name)=>name.replace(/[^a-zA-Z0-9\s]/g," ").trim().split(/\s+/).map((w,i)=>(i===0?w.toLowerCase():w[0].toUpperCase()+w.slice(1).toLowerCase())).join("");

const manualKeys = {
  "Safe Shallows": "safeShallows",
  "Kelp Forest": "kelpForest",
  "Grassy Plateaus": "grassyPlateaus",
  "Mushroom Forest": "mushroomForest",
  "kooshZone": "KooshZone",
  "Blood Kelp": "bloodKelp",
  "Underwater Islands": "underwaterIslands",
  "Crag Field": "cragField",
  "Sparse Reef": "sparseReef",
  "Mountains": "mountains",
  "Grand Reef": "grandReef",
  "Sea Treaders Path": "seaTreadersPath",
  "Dunes": "dunes",
  "Crash Zone": "crashZone",
  "Mountain Island": "mountainIsland",
  "Floating Island": "floatingIsland",
  "Jelly Shroom Caves": "jellyShroomCaves",
  "Lost River": "lostRiver",
  "Inactive Lava Zone": "inactiveLavaZone",
  "Active Lava Zone": "activeLavaZone",
  "Entire Map": "entiremap"
};

const displayNames = [
  "Safe Shallows","Kelp Forest","Grassy Plateaus","Mushroom Forest","Bulb Zone",
  "Blood Kelp","Underwater Islands","Crag Field","Sparse Reef","Mountains",
  "Grand Reef","Sea Treaders Path","Dunes","Crash Zone","Mountain Island",
  "Floating Island","Jellyshroom Caves","Lost River","Inactive Lava Zone","Active Lava Zone"
];

const rowOrder = [
  ["Safe Shallows","Kelp Forest","Grassy Plateaus","Mushroom Forest","Bulb Zone"],
  ["Blood Kelp","Underwater Islands","Crag Field","Sparse Reef","Mountains"],
  ["Grand Reef","Sea Treaders Path","Dunes","Crash Zone","Mountain Island"],
  ["Floating Island","Jellyshroom Caves","Lost River","Inactive Lava Zone","Active Lava Zone"]
];

const IMAGE_MODE={NORMAL:"normal", DEG360:"360"};
let selectedImageMode=IMAGE_MODE.NORMAL;
const gamemodes = displayNames.map(d=>({display:d, key:manualKeys[d]||toKey(d)}));

const container=document.getElementById("gamemode-container");
const leaderboard=document.getElementById("leaderboard");
const leaderboardBody=document.getElementById("leaderboard-body");
const selectedModeTitle=document.getElementById("selected-mode-title");
const playBtn=document.getElementById("play-btn");
const normalBtn=document.getElementById("normal-btn");
const mode360Btn=document.getElementById("mode360-btn");
const usernameInput=document.getElementById("username-input");
const creditsDiv=document.getElementById("credits");
const defaultBackground="Background/DashboardBackground.png";
const backgroundPath="Background";
let currentBiome=null;

function updateImageModeStorage(){const is360=selectedImageMode===IMAGE_MODE.DEG360; localStorage.setItem("selectedImageMode",is360?"360":"normal");}

// Render biomes in rows
function renderBiomeRows() {
  container.innerHTML = "";
  rowOrder.forEach(row => {
    const rowDiv = document.createElement("div");
    rowDiv.className = "gamemode-row";
    row.forEach(name => {
      const card = document.createElement("div");
      card.className = "gamemode-card";
      card.textContent = name;
      card.style.backgroundImage = `url('${backgroundPath}/${name}.jpg')`;
      card.onclick = () => showLeaderboard({ display: name, key: manualKeys[name] });
      rowDiv.appendChild(card);
    });
    container.appendChild(rowDiv);
  });
}

window.addEventListener("DOMContentLoaded",()=>{
  const savedUsername=sessionStorage.getItem("username");
  if(savedUsername) usernameInput.value=savedUsername;
  renderBiomeRows();
});

// Format leaderboard time
function formatTime(seconds){
  const mins=Math.floor(seconds/60);
  const secs=(seconds%60).toFixed(2);
  return mins>0?`${mins}:${secs.padStart(5,"0")}`:`${secs}s`;
}

// Show leaderboard
async function showLeaderboard(gm){
  const username=usernameInput.value.trim();
  if(!username){ alert("Please enter a username before selecting a biome!"); return; }
  sessionStorage.setItem("username", username);

  usernameInput.disabled=true;
  usernameInput.style.backgroundColor="rgba(10, 26, 32, 0.5)";
  usernameInput.style.color="#888";
  usernameInput.style.cursor="not-allowed";

  currentBiome=gm;
  document.body.style.backgroundImage=`url('${backgroundPath}/${gm.display}.jpg')`;
  container.style.opacity="0";
  document.querySelector(".entire-map").style.opacity="0";

  setTimeout(()=>{
    container.style.display="none";
    document.querySelector(".entire-map").style.display="none";
    creditsDiv.classList.remove("active");
    leaderboard.style.display="flex";
    setTimeout(()=>leaderboard.classList.add("active"),50);
  },400);

  selectedModeTitle.textContent=`üèÜ ${gm.display} Leaderboard`;
  leaderboardBody.innerHTML="<tr><td colspan='4'>Loading...</td></tr>";

  try {
    const table="leaderboards";
    const biome=(gm.display||"").toLowerCase();
    let { data, error } = await supabase.from(table)
      .select("*")
      .ilike("biome", biome)
      .order("score",{ascending:false})
      .order("time",{ascending:true})
      .ilike("gamemode", selectedImageMode);

    leaderboardBody.innerHTML="";

    if(error){ leaderboardBody.innerHTML="<tr><td colspan='4'>Error loading leaderboard</td></tr>"; console.error(error); return; }
    if(!data||data.length===0){ leaderboardBody.innerHTML="<tr><td colspan='4'>No scores yet!</td></tr>"; return; }

    const bestScores={};
    data.forEach(entry=>{
      const existing=bestScores[entry.username];
      if(!existing || entry.score>existing.score || (entry.score===existing.score && entry.time<existing.time)){
        bestScores[entry.username]=entry;
      }
    });

    const uniqueEntries=Object.values(bestScores)
      .sort((a,b)=>b.score-a.score || a.time-b.time)
      .slice(0,10);

    uniqueEntries.forEach((entry,i)=>{
      const row=document.createElement("tr");
      row.innerHTML=`<td>${i+1}</td><td>${entry.username}</td><td>${entry.score}</td><td>${formatTime(entry.time)}</td>`;
      const currentUsername=sessionStorage.getItem("username");
      if(entry.username===currentUsername){
        row.style.backgroundColor="rgba(0, 255, 255, 0.2)";
        row.style.fontWeight="bold";
        row.style.color="#00ffff";
        row.style.boxShadow="0 0 12px rgba(0, 255, 255, 0.5)";
      }
      leaderboardBody.appendChild(row);
    });
  } catch(e){ console.error(e); leaderboardBody.innerHTML="<tr><td colspan='4'>Error loading leaderboard</td></tr>"; }
}

// Image mode buttons
normalBtn.onclick=()=>{
  selectedImageMode=IMAGE_MODE.NORMAL;
  normalBtn.classList.add("active");
  mode360Btn.classList.remove("active");
  updateImageModeStorage();
  if(currentBiome) showLeaderboard(currentBiome);
};
mode360Btn.onclick=()=>{
  selectedImageMode=IMAGE_MODE.DEG360;
  mode360Btn.classList.add("active");
  normalBtn.classList.remove("active");
  updateImageModeStorage();
  if(currentBiome) showLeaderboard(currentBiome);
};

// Entire map button
document.querySelector(".entire-map").onclick=()=>showLeaderboard({display:"Entire Map", key:manualKeys["Entire Map"]});

// Play button
playBtn.onclick=async()=>{
  try{
    const response=await fetch("locations360.json");
    const locations=await response.json();
    const hasBiome=currentBiome.display==="Entire Map"?true:locations.some(loc=>loc.biome===currentBiome.key || loc.biome===currentBiome.display);
    if(!hasBiome){ alert(`No locations found for ${currentBiome.display}!`); return; }
    updateImageModeStorage();
    localStorage.setItem("selectedBiomeKey",currentBiome.key);
    localStorage.setItem("selectedBiomeDisplay",currentBiome.display);
    localStorage.setItem("selectedImageMode",selectedImageMode);
    window.location.href="game.html";
  }catch(err){ console.error(err); alert("Error loading locations.json"); }
};

// Return to dashboard
function returnToDashboard(){
  if(event && event.target.id==="credits-btn"){ return; } // avoid triggering when clicking Credits button
  leaderboard.classList.remove("active");
  creditsDiv.classList.remove("active");
  setTimeout(()=>{
    leaderboard.style.display="none";
    creditsDiv.style.display="none";
    container.style.display="flex";
    document.querySelector(".entire-map").style.display="inline-block";
    document.body.style.backgroundImage=`url('${defaultBackground}')`;

    usernameInput.disabled=false;
    usernameInput.style.backgroundColor="#0a1a20cc";
    usernameInput.style.color="#00ffff";
    usernameInput.style.cursor="text";

    setTimeout(()=>{
      container.style.opacity="1";
      document.querySelector(".entire-map").style.opacity="1";
    },50);
  },300);
}

// Credits tab
function showCredits(e){
  e.stopPropagation();
  container.style.display="none";
  document.querySelector(".entire-map").style.display="none";
  leaderboard.classList.remove("active");
  creditsDiv.style.display="flex";
  setTimeout(()=>creditsDiv.classList.add("active"),50);
}
</script>
</body>
</html>