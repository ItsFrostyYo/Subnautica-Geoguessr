<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subnautica GeoGuessr</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      margin: 0;
      color: #00ffff;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      overflow-x: hidden;
      background: url("images/DashboardBackground.png") no-repeat center center fixed;
      background-size: cover;
      position: relative;
      transition: background-image 0.8s ease-in-out;
    }
    body::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(10, 15, 20, 0.75);
      z-index: 0;
    }
    * { position: relative; z-index: 1; }

    header {
      margin-top: 10px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      transition: color 0.3s;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      transition: color 0.3s, transform 0.3s;
    }
    h1:hover { color: #00cccc; transform: scale(1.03); }

    p {
      margin-bottom: 10px;
    }

    .username-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    #username-input {
      background: #0a1a20cc;
      border: 2px solid #00ffff;
      border-radius: 10px;
      color: #00ffff;
      padding: 10px 15px;
      font-size: 1rem;
      width: 200px;
      text-align: center;
      outline: none;
      transition: all 0.3s ease;
    }
    #username-input:focus {
      box-shadow: 0 0 12px #00ffff;
    }

    #set-username-btn {
      background: none;
      border: 2px solid #00ffff;
      color: #00ffff;
      font-size: 1rem;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
    }
    #set-username-btn:hover {
      background: #00ffff;
      color: #0a0f14;
      transform: scale(1.05);
    }

    .gamemode-container {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 25px;
      max-width: 1200px;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    .gamemode-card {
      border: 2px solid #00ffff;
      border-radius: 15px;
      padding: 20px;
      width: 220px;
      height: 70px;
      text-align: center;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.15);
      cursor: pointer;
      transition: all 0.25s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: bold;
      color: #00ffff;
      background-size: cover;
      background-position: center;
      text-shadow: 0 0 6px #000, 0 0 10px #000;
    }
    .gamemode-card:hover {
      transform: scale(1.07);
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.35);
      background-color: #0e1b22cc;
    }

    .entire-map {
      margin-top: 40px;
      width: 80%;
      max-width: 600px;
      background: radial-gradient(circle at center, #00ffff55, #00ffff22 80%);
      border: 3px solid #00ffff;
      color: #00ffff;
      border-radius: 25px;
      padding: 40px 0;
      font-size: 1.8rem;
      letter-spacing: 1px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: all 0.4s ease;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.25);
      margin-bottom: 15px;
    }
    .entire-map:hover {
      transform: scale(1.05);
      box-shadow: 0 0 60px rgba(0, 255, 255, 0.6);
      background: radial-gradient(circle at center, #00ffff88, #00ffff33 80%);
      color: #0a0f14;
    }

    .leaderboard {
      display: none;
      flex-direction: column;
      align-items: center;
      margin-top: 40px;
      background-color: #112029cc;
      border: 2px solid #00ffff;
      border-radius: 15px;
      padding: 20px;
      width: 400px;
      text-align: center;
      opacity: 0;
      transform: scale(0.98);
      transition: opacity 0.5s ease, transform 0.4s ease;
    }
    .leaderboard.active { display: flex; opacity: 1; transform: scale(1); }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #00ffff; padding: 8px; }
    th { color: #00ffff; } td { color: white; }

    .play-btn {
      background-color: #00ffff;
      border: none;
      color: #0a0f14;
      font-size: 1.2rem;
      font-weight: bold;
      padding: 10px 25px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    .play-btn:hover {
      transform: scale(1.07);
      box-shadow: 0 0 12px #00ffff;
    }
  </style>
</head>
<body>
  <header onclick="returnToDashboard()">
    <h1>Subnautica GeoGuessr</h1>
    <p>Dive Into the depths and Test Your Location Knowledge | Please Set a Username Below</p>

    <div class="username-container">
      <input id="username-input" type="text" placeholder="Enter username" />
      <button id="set-username-btn" onclick="setUsername()">Set Username</button>
    </div>
  </header>

  <div class="gamemode-container" id="gamemode-container"></div>

  <button class="entire-map" onclick="showLeaderboard('Entire Map')">üåç Play the Entire Subnautica Map üåç</button>

  <div class="leaderboard" id="leaderboard">
    <h2 id="selected-mode-title">üèÜ Leaderboard</h2>
    <table id="leaderboard-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>Score</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
    <button class="play-btn" id="play-btn">Play</button>
  </div>

  <script>
    const SUPABASE_URL = "https://ayasirbxjxwslknhbsvn.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5YXNpcmJ4anh3c2xrbmhic3ZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMjY1ODcsImV4cCI6MjA3NTYwMjU4N30.5E-ffTjzZ4pxkubtcBINHh_Jw9d6vltDs1kH8aAqB60";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const gamemodes = [
      "Safe Shallows", "Kelp Forest", "Grassy Plateau", "Mushroom Forest",
      "Bulb Zone", "Blood Kelp", "Underwater Islands", "Crag Field",
      "Sparse Reef", "Mountains", "Grand Reef", "Sea Treaders Path",
      "Dunes", "Crash Zone", "Mountain Island", "Floating Island"
    ];

    const container = document.getElementById("gamemode-container");
    const leaderboard = document.getElementById("leaderboard");
    const leaderboardBody = document.getElementById("leaderboard-body");
    const selectedModeTitle = document.getElementById("selected-mode-title");
    const playBtn = document.getElementById("play-btn");
    const usernameInput = document.getElementById("username-input");

    const defaultBackground = "images/DashboardBackground.png";
    const backgroundPath = "Background";

    // Auto-fill username if already stored
    window.addEventListener("DOMContentLoaded", () => {
      const savedUsername = sessionStorage.getItem("username");
      if (savedUsername) usernameInput.value = savedUsername;
    });

    gamemodes.forEach(mode => {
      const card = document.createElement("div");
      card.className = "gamemode-card";
      card.textContent = mode;
      card.style.backgroundImage = `url('${backgroundPath}/${mode}.jpg')`;
      card.onclick = () => showLeaderboard(mode);
      container.appendChild(card);
    });

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = (seconds % 60).toFixed(2);
      return mins > 0 ? `${mins}:${secs.padStart(5, "0")}` : `${secs}s`;
    }

    async function showLeaderboard(mode) {
      const username = sessionStorage.getItem("username");
      if (!username) {
        alert("Please set a username first!");
        return;
      }

      document.body.style.backgroundImage = `url('${backgroundPath}/${mode}.jpg')`;

      container.style.opacity = "0";
      document.querySelector(".entire-map").style.opacity = "0";
      setTimeout(() => {
        container.style.display = "none";
        document.querySelector(".entire-map").style.display = "none";
        leaderboard.style.display = "flex";
        setTimeout(() => leaderboard.classList.add("active"), 50);
      }, 400);

      selectedModeTitle.innerHTML = `üèÜ ${mode} Leaderboard`;
      leaderboardBody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

      const { data, error } = await supabase
        .from("leaderboards")
        .select("*")
        .ilike("biome", mode)
        .order("score", { ascending: false })
        .order("time", { ascending: true });

      leaderboardBody.innerHTML = "";

      if (error) {
        leaderboardBody.innerHTML = `<tr><td colspan='4'>Error loading leaderboard</td></tr>`;
        console.error(error);
        return;
      }

      if (!data || data.length === 0) {
        leaderboardBody.innerHTML = `<tr><td colspan='4'>No scores yet!</td></tr>`;
      } else {
        const bestScores = {};
        data.forEach(entry => {
          const existing = bestScores[entry.username];
          if (!existing || entry.score > existing.score ||
              (entry.score === existing.score && entry.time < existing.time)) {
            bestScores[entry.username] = entry;
          }
        });

        const uniqueEntries = Object.values(bestScores)
          .sort((a, b) => b.score - a.score || a.time - b.time)
          .slice(0, 10);

        uniqueEntries.forEach((entry, i) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${i + 1}</td>
            <td>${entry.username}</td>
            <td>${entry.score}</td>
            <td>${formatTime(entry.time)}</td>
          `;
          leaderboardBody.appendChild(row);
        });
      }

      playBtn.onclick = () => checkAndStartGame(mode);
    }

    async function checkAndStartGame(biome) {
      try {
        const response = await fetch("locations.json");
        const locations = await response.json();

        let hasBiome = true;
        if (biome !== "Entire Map") {
          hasBiome = locations.some(loc => loc.biome === biome);
        }

        if (!hasBiome) {
          alert(`No locations found for ${biome}!`);
          return;
        }

        localStorage.setItem("selectedBiome", biome);
        window.location.href = "game.html";
      } catch (err) {
        console.error("Error loading locations.json:", err);
        alert("Error loading locations ‚Äî please check your files!");
      }
    }

    function returnToDashboard() {
      leaderboard.classList.remove("active");
      setTimeout(() => {
        leaderboard.style.display = "none";
        container.style.display = "flex";
        document.querySelector(".entire-map").style.display = "inline-block";
        document.body.style.backgroundImage = `url('${defaultBackground}')`;
        setTimeout(() => {
          container.style.opacity = "1";
          document.querySelector(".entire-map").style.opacity = "1";
        }, 50);
      }, 300);
    }

    function setUsername() {
      const newUsername = usernameInput.value.trim();
      if (newUsername !== "") {
        sessionStorage.setItem("username", newUsername);
        alert(`Username set to: ${newUsername}`);
      } else {
        alert("Please enter a valid username!");
      }
    }
  </script>
</body>
</html>
