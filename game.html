<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Geonautica | In Round(s) (Update 0.6.0-Beta of December 27, 2025)</title>
<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
  #viewer {width:100%;height:100%;}
  #mapContainer{position:fixed;right:20px;bottom:20px;width:420px;height:420px;border-radius:10px;border:2px solid #0ff;overflow:hidden;z-index:40;background: rgb(24, 26, 28);}
  #map{width:100%;height:100%}
  #controlsTop{position:fixed;right:20px;bottom:450px;display:flex;justify-content:center;width:420px;z-index:60;}
  button{background:#00ffff22;border:1px solid #00ffff88;color:#fff;padding:6px 10px;border-radius:6px;margin:0;cursor:pointer;font-size:14px;}
  button:hover{background:#00ffff55;}
  #topInfo{position:fixed;top:15px;left:50%;transform:translateX(-50%);display:flex;gap:12px;align-items:center;background:#00000055;padding:8px 14px;border-radius:10px;border:1px solid #00ffff44;z-index:80;}
  #roundDisplay,#timerDisplay{background:#00ffff22;border:1px solid #00ffff88;color:#fff;padding:6px 10px;border-radius:6px;font-size:14px;user-select:none;}
  #summaryOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);color:white;display:none;flex-direction:column;justify-content:center;align-items:center;font-size:18px;z-index:100;}
  #summaryOverlay button{margin-top:15px;font-size:16px;}
  #result{color:#cfe;margin-top:6px;position:fixed;left:20px;bottom:20px;z-index:60}
  #loadingScreen{position:fixed;inset:0;background:rgba(0,0,0,0.8);color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:sans-serif;font-size:1.3em;z-index:9999;opacity:0;transition:opacity .3s ease;pointer-events:none}
  #loadingScreen.visible{opacity:1;pointer-events:all}.spinner{width:60px;height:60px;border:5px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .9s linear infinite;margin-bottom:15px}
  @keyframes spin{to{transform:rotate(360deg)}}

#compassBar {
  position: fixed;
  top: 100px; /* moved down from 60px to avoid overlap */
  left: 50%;
  transform: translateX(-50%);
  width: 540px; /* 360 * 1.5 */
  height: 27px; /* 18 * 1.5 */
  background: rgba(0, 0, 0, 0.45);
  border: 1px solid #0ff;
  border-radius: 13.5px; /* 50% of height */
  overflow: hidden;
  z-index: 100;
  box-shadow: 0 0 12px #0ff50a33 inset;
}

#compassBar .compassLabels {
  display: flex;
  white-space: nowrap;
  font-size: 18px; /* 12 * 1.5 */
  color: #0ff;
  font-weight: bold;
  align-items: center;
  height: 100%;
  margin-left: -48px; /* shift left by half a label width */
}

#compassBar .compassLabels span {
  flex: 0 0 67.5px; /* 45 * 1.5 */
  text-align: center;
}

#compassBar .pointer {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 3px; /* 2 * 1.5 */
  height: 100%;
  background: #ff5555;
  box-shadow: 0 0 7.5px #ff5555;
  z-index: 10;
  border-radius: 1.5px;
}

#back-button {
  position: fixed;
  top: 20px;
  left: 22px;
  display: block; /* make it visible always */
  border: 2px solid #00ffff;
  border-radius: 12px;
  padding: 8px 18px;
  background: none;
  color: #00ffff;
  cursor: pointer;
  z-index: 999;
}

#back-button:hover {
  transform: scale(1.06);
  box-shadow: 0 0 18px #00ffff;
}

</style>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.css" />
</head>
<body>
  <div id="loadingScreen" class="hidden">
    <div class="spinner"></div>
    <div class="loadingText">Loading next location...</div>
  </div>

  <div id="viewer" style="width: 100vw; height: 100vh;"></div>

<div id="compassBar">
  <div class="compassLabels">
    <!-- repeated twice to allow smooth sliding -->
    <span>N</span><span>NE</span><span>E</span><span>SE</span><span>S</span><span>SW</span><span>W</span><span>NW</span>
    <span>N</span><span>NE</span><span>E</span><span>SE</span><span>S</span><span>SW</span><span>W</span><span>NW</span>
  </div>
  <div class="pointer"></div>
</div>

</div>


  <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js",
            "@photo-sphere-viewer/core": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.module.js"
        }
    }
  </script>

  <div id="mapContainer">
    <select id="mapSelect" style="background:#111;color:#fff;border:1px solid #444;border-radius:6px;padding:4px 8px;">
        <option value="main">Main</option>
        <option value="lost_river">Lost River</option>
        <option value="inactive_lavazone">Inactive Lava Zone</option>
        <option value="lava_lakes">Lava Lakes</option>
        <option value="jellyshroom">Jellyshroom</option>
      </select>
    <canvas id="mapCanvas" style="width:100%; height:100%; display:block;"></canvas>
</div>

  <div id="controlsTop"><button id="submit">Submit Guess (Space)</button></div>

  <div id="topInfo">
    <div id="roundDisplay">Round 1 / 5</div>
    <div id="timerDisplay">0:00.00</div>
  </div>

  <div id="result"></div>

  <div id="summaryOverlay">
    <div id="summaryText"></div>
    <div id="summaryButtons" style="margin-top:12px;"></div>
    <button id="restartBtn" style="display:none;">Play Again</button>
 
  </div>

  <button id="back-button">← Exit to Dashboard</button>

<script type="module">
import { Viewer } from '@photo-sphere-viewer/core';
 //(Temporary Disable, No Leaderboard Currently) import { saveScore } from './supabase.js';
import { GameMap } from './GameMap.js';

(() => {  
  let places = [], current = 0, totalScore = 0, guess = null;
  let totalElapsed = 0, roundStartTime = 0, timerInterval = null;
  let map = null;
  const IMAGE_MODE = { NORMAL: "normal", DEG360: "360" };
  const times = [];
  const selectedBiome = localStorage.getItem('selectedBiomeKey') || 'safeShallows';
  const username = sessionStorage.getItem("username") || "Unknown";
  let selectedImageMode = localStorage.getItem('selectedImageMode') || '360';
  let mapLocked = false;
  let roundLocked = false;
  const MAX_ROUNDS = 5;
  const MAX_SCORE_ALLOWED = 25000;

  const canvas = document.getElementById('mapCanvas');
  const select = document.getElementById('mapSelect');
  const mouseLabel = document.getElementById('mouseLabel');

  const timerDisplay = document.getElementById('timerDisplay');
  const roundDisplay = document.getElementById('roundDisplay');
  const summaryOverlay = document.getElementById('summaryOverlay');
  const summaryText = document.getElementById('summaryText');
  const summaryButtons = document.getElementById('summaryButtons');
  const result = document.getElementById('result');

  const BIOME_SCORING_RULES = {
  SMALL: {
    radius: 10,
    scale: 4.50,
    keys: [
      "Safe Shallows",
      "Kelp Forest",
      "Sparse Reef",
      "Sea Treaders Path",
      "Floating Island",
      "Alien Base"
    ]
  },

  MEDIUM: {
    radius: 17,
    scale: 4.40,
    keys: [
      "Blood Kelp",
      "Underwater Islands",
      "Bulb Zone",
      "Mushroom Forest",
      "Crag Field"
    ]
  },

  LARGE: {
    radius: 20,
    scale: 4.30,
    keys: [
      "Dunes",
      "Mountains",
      "Crash Zone",
      "Grand Reef",
      "Jellyshroom Caves",
      "Lost River",
      "Active Lava Zone",
      "Inactive Lava Zone"
    ]
  },

  ENTIRE_MAP: {
    radius: 17,
    scale: 4.35
  }
};

function getBiomeScoring() {
  const biome = localStorage.getItem("selectedBiomeDisplay");

  if (biome === "Entire Map") {
    return BIOME_SCORING_RULES.ENTIRE_MAP;
  }

  if (BIOME_SCORING_RULES.SMALL.keys.includes(biome)) {
    return BIOME_SCORING_RULES.SMALL;
  }

  if (BIOME_SCORING_RULES.MEDIUM.keys.includes(biome)) {
    return BIOME_SCORING_RULES.MEDIUM;
  }

  if (BIOME_SCORING_RULES.LARGE.keys.includes(biome)) {
    return BIOME_SCORING_RULES.LARGE;
  }

  // fallback safety
  return BIOME_SCORING_RULES.MEDIUM;
}

  const viewer = new Viewer({
        container: document.querySelector('#viewer'),
        panorama: 'Background/DashboardBackground.png',
    });

  function showLoadingScreen() {
    const screen = document.getElementById("loadingScreen");
    screen.classList.add("visible");
  } 

  function hideLoadingScreen() {
    const screen = document.getElementById("loadingScreen");
    screen.classList.remove("visible");
  }

  function formatTime(ms) {
    const totalSeconds = ms / 1000;
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = Math.floor(totalSeconds % 60);
    const hundredths = Math.floor((totalSeconds - Math.floor(totalSeconds)) * 100);
    return `${minutes}:${seconds.toString().padStart(2,'0')}.${hundredths.toString().padStart(2,'0')}`;
  }

  function startTimer() {
    clearInterval(timerInterval);
    roundStartTime = performance.now();
    timerInterval = setInterval(() => {
      const elapsed = performance.now() - roundStartTime;
      timerDisplay.textContent = formatTime(elapsed);
    }, 31);
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
      const roundElapsed = performance.now() - roundStartTime;
      totalElapsed += roundElapsed;
      times.push(roundElapsed);
      timerDisplay.textContent = formatTime(roundElapsed);
    }
  }

  function distanceWorld(a,b,c,d){return Math.hypot(a-c,b-d);}
  function scoreFromDistance(distance) {
  const { radius, scale } = getBiomeScoring();

  if (distance <= radius) return 5000;
  return Math.max(0, Math.round(5000 - (distance - radius) * scale));
}

    async function getLatestCommitSha({
  owner = 'ItsFrostyYo',
  repo = 'Subnautica-Geoguessr-Images',
  branch = 'main',
  cacheTtlMs = 5 * 60 * 1000
} = {}) {
  const cacheKey = `latestSha:${owner}/${repo}@${branch}`;
  try {
    const cached = JSON.parse(localStorage.getItem(cacheKey) || 'null');
    if (cached && (Date.now() - cached.time) < cacheTtlMs && cached.sha) {
      return cached.sha;
    }

    const res = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/commits/${encodeURIComponent(branch)}`
    );
    if (!res.ok) throw new Error(`GitHub API ${res.status}`);
    const data = await res.json();
    const sha = data && data.sha;
    if (typeof sha === 'string' && sha.length >= 7) {
      localStorage.setItem(cacheKey, JSON.stringify({ sha, time: Date.now() }));
      return sha;
    }
    throw new Error('No SHA in response');
  } catch (e) {
    console.warn('Failed to get latest commit SHA, falling back to @main:', e);
    return null;
  }
}

async function loadImageToMemory(place) {
  try {
    const res = await fetch(place.image);
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    place.image = url;
    place.loaded = true;
  } catch (err) {
    console.error(`Error while loading ${place.image}:`, err);
    place.loaded = false;
  }
}

async function loadLocations() {
  summaryButtons.innerHTML = '';

  // Load all available locations
  const res = await fetch(`locations360.json?cacheBust=${Date.now()}`);
  const data = await res.json();

  // Get selected biome(s)
  const selectedBiomeDisplay = localStorage.getItem("selectedBiomeDisplay") || selectedBiome;
  const selectedBiomeKeys = JSON.parse(localStorage.getItem("selectedBiomeKeys") || "[]");

  let source;

  // ✅ If "Entire Map" is selected, use *all* biomes
  if (selectedBiomeDisplay === "Entire Map" || selectedBiomeKeys.length === 0) {
    source = data;
  } else {
    // ✅ Otherwise, use the saved biome list
    source = data.filter(i => selectedBiomeKeys.includes(i.biome));
  }

  if (!source.length) {
    alert(`No locations found for "${selectedBiomeDisplay}".`);
    return;
  }

  // Fetch latest commit for image versioning
  const sha = await getLatestCommitSha();

  // Shuffle and select up to MAX_ROUNDS
  const shuffled = source.sort(() => 0.5 - Math.random());
  places = shuffled.slice(0, Math.min(MAX_ROUNDS, shuffled.length)).map(i => ({
    ...i,
    coords: { x: Number(i.x), z: Number(i.z) },
    yaw: i.yaw,
    pitch: i.pitch,
    biome: i.biome,
    image: `https://cdn.jsdelivr.net/gh/ItsFrostyYo/Subnautica-Geoguessr-Images@${sha}/${i.image}`,
    loaded: false
  }));

  // Preload each image before starting
  (async () => {
    for (const p of places) {
      await loadImageToMemory(p);
      console.log(`Loaded: ${p.biome} -> ${p.image}`);
    }
  })();

  totalScore = 0;
  totalElapsed = 0;
  times.length = 0;

  startRound(0);
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
async function waitForCondition(checkFn, interval=40){while(!checkFn())await sleep(interval);}

async function startRound(i) {
  if (i >= MAX_ROUNDS || i >= places.length) return;

  const place = places[i];
  showLoadingScreen();

  if (!place.loaded) await waitForCondition(() => place.loaded);
  hideLoadingScreen();

  // ✅ faster movement and zoom
  if (selectedImageMode === '360') {
    viewer.setOption('mousemove', true);
    viewer.setOption('mousewheel', true);
    viewer.setOption('touchmoveTwoFingers', true);
    viewer.setOption('zoomSpeed', 5);
    viewer.navbar.show();
  } else {
    viewer.setOption('mousemove', false);
    viewer.setOption('mousewheel', false);
    viewer.setOption('touchmoveTwoFingers', false);
    viewer.navbar.hide();
  }

  viewer.setPanorama(places[i].image, {
    position: {
      yaw: `${places[i].yaw + 180}deg`,
      pitch: `${-places[i].pitch}deg`
    },
    sphereCorrection: {
      roll: `${places[i].roll || 0}deg`
    },
    zoom: 0,
    transition: false
  });

  current = i;
  roundDisplay.textContent = `Round ${i + 1} / ${places.length}`;
  guess = null;
  result.textContent = '';
  mapLocked = false;
  roundLocked = false;

  if (map) {
    map.drawActualMarker = false;
    map.drawLine = false;
    map.clearGuessMarker();
    map.flyTo([0, 0], -3.3, { duration: 0.5 });
  }
    
  timerDisplay.textContent = '0:00.00';
  startTimer();
}

function showSummaryRound(d,s){
  stopTimer();
  summaryButtons.innerHTML=''; 
  summaryOverlay.style.display='flex';
  summaryText.innerHTML=`<h2>Round ${current+1} Complete</h2><p>Distance: ${Math.round(d)} m</p><p>Score: ${s}</p><p>Loading next round...</p>`;
  roundLocked=true;
  summaryOverlay.onclick=null;
  document.removeEventListener('keydown',nextRoundKey);
  setTimeout(()=>{
    roundLocked=false;
    summaryText.innerHTML=`<h2>Round ${current+1} Complete</h2><p>Distance: ${Math.round(d)} m</p><p>Score: ${s}</p><p>Press Space or Click to Continue</p>`;
    document.addEventListener('keydown',nextRoundKey,{once:true});
    summaryOverlay.onclick=()=>{document.removeEventListener('keydown',nextRoundKey);nextRound();};
  },500);
}

function nextRoundKey(e){if(e.code==='Space'&&!roundLocked)nextRound();}
function nextRound(){
  if(roundLocked)return;
  summaryOverlay.onclick=null;
  summaryOverlay.style.display='none';
  summaryButtons.innerHTML='';
  current++;
  if(current<places.length&&current<MAX_ROUNDS)startRound(current);
  else {showFinalSummary();places.forEach(p=>URL.revokeObjectURL(p.image));}
}

async function showFinalSummary(){
  const totalTimeSec=Number((totalElapsed/1000).toFixed(2));
  summaryOverlay.style.display='flex';
  const biome_display=localStorage.getItem('selectedBiomeDisplay')||selectedBiome;
  summaryText.innerHTML=`<h2>Game Over</h2><p>Username: ${username}</p><p>Biome: ${biome_display}</p><p>Total Score: ${totalScore}</p><p>Total Time: ${formatTime(totalElapsed)}</p>`;
  summaryButtons.innerHTML='';
  if(totalScore<=MAX_SCORE_ALLOWED){
    try{
      const biome_key=(selectedBiome||"").toLowerCase();
      //(Temporary Disable, No Leaderboard Currently) await saveScore(username,biome_display,totalScore,totalTimeSec,selectedImageMode);
    }catch(e){console.error("Error saving score:",e);}
  }else console.warn("Rejected invalid total score:",totalScore);
  const again=document.createElement('button');again.textContent='Play Again';again.onclick=()=>{summaryOverlay.style.display='none';loadLocations();};
  const dash=document.createElement('button');dash.textContent='Return to Dashboard';dash.onclick=()=>window.location.href='index.html';
  summaryButtons.appendChild(again);summaryButtons.appendChild(dash);
}

function submitGuess(){
  if(mapLocked||roundLocked)return;
  if(!map.guessMarker)return;
  mapLocked=true;roundLocked=true;
  const actual=places[current].coords;
  const d=distanceWorld(actual.x,actual.z,map.guessMarker.x,map.guessMarker.y);
  const s = scoreFromDistance(d, places[current].biome);
  totalScore+=s;
  result.textContent=`Distance: ${Math.round(d)} m — Score: ${s}`;

  if(map){
    map.clearActualMarker();
    map.setActualMarker(actual.x,actual.z);
    map.drawActualMarker=true;
    map.drawLine=true;
    map.flyTo([actual.z,actual.x],0.75,{duration:0.5,easeLinearity:0.25});
  }
  setTimeout(()=>showSummaryRound(d,s),400);
}

function initMap(){
  const m1=Object.assign(new Image(),{src:'Marker1.png'});
  const m2=Object.assign(new Image(),{src:'Marker2.png'});
  map=new GameMap(canvas,{
    worldMin:-2048,worldMax:2048,
    zoomSpeed:1.15,zoomLerpSpeed:0.1,
    minZoom:0.1,maxZoom:10,
    guessMarkerOffset:{x:0,y:-10},
    actualMarkerOffset:{x:0,y:-10},
    guessMarkerImage:m2,
    actualMarkerImage:m1
  });

  const resizeCanvas=()=>{const r=canvas.getBoundingClientRect();const dpr=window.devicePixelRatio||1;canvas.width=Math.round(r.width*dpr);canvas.height=Math.round(r.height*dpr);};
  resizeCanvas();new ResizeObserver(resizeCanvas).observe(document.body);

  select.addEventListener('change',()=>{
    const key=select.value;
    map.guessMarker=null;
    map.clearActualMarker?.();
    map.setMap({imageSrc:map.IMAGES[key],recenter:true});
    map.flyToWorld?.(map.camera.x,map.camera.y,null,{duration:0.35,easeLinearity:0.25});
  });
}

document.getElementById('submit').addEventListener('click',submitGuess);
document.addEventListener('keydown',e=>{if(e.code==='Space'&&summaryOverlay.style.display==='none'&&!roundLocked)submitGuess();});

const compassLabels = document.querySelector('#compassBar .compassLabels');
const barWidth = 540; // matches updated CSS width
viewer.addEventListener('position-updated', (e) => {
  let yawDeg = e.position.yaw * (180 / Math.PI);

  if (yawDeg < 0) yawDeg += 360;

  const shift = -yawDeg * (barWidth / 360);
  compassLabels.style.transform = `translateX(${shift}px)`;
});

const backButton = document.getElementById('back-button');
backButton.addEventListener('click', () => {
  // hide overlays if needed
  document.getElementById('summaryOverlay').style.display = 'none';
  document.getElementById('compassBar').style.display = 'none';
  
  // go back to dashboard
  window.location.href = "index.html";
});

const img=new Image();
img.onload=()=>{initMap();loadLocations();};
img.src='map_main.webp';
})();
</script>
</body>
</html>