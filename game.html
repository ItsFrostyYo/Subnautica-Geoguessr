<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Subnautica GeoGuessr — Web Edition (Smooth Zoom Update)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
  #photo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
  #mapContainer{position:fixed;right:20px;bottom:20px;width:420px;height:420px;border-radius:10px;border:2px solid #0ff;overflow:hidden;z-index:40;background:#00161a}
  #map{width:100%;height:100%}
  #controlsTop{position:fixed;right:20px;bottom:450px;display:flex;justify-content:center;width:420px;z-index:60;}
  button{background:#00ffff22;border:1px solid #00ffff88;color:#fff;padding:6px 10px;border-radius:6px;margin:0;cursor:pointer;font-size:14px;}
  button:hover{background:#00ffff55;}
  #topInfo{position:fixed;top:15px;left:50%;transform:translateX(-50%);display:flex;gap:12px;align-items:center;background:#00000055;padding:8px 14px;border-radius:10px;border:1px solid #00ffff44;z-index:80;}
  #roundDisplay,#timerDisplay{background:#00ffff22;border:1px solid #00ffff88;color:#fff;padding:6px 10px;border-radius:6px;font-size:14px;user-select:none;}
  #summaryOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);color:white;display:none;flex-direction:column;justify-content:center;align-items:center;font-size:18px;z-index:100;}
  #summaryOverlay button{margin-top:15px;font-size:16px;}
  #result{color:#cfe;margin-top:6px;position:fixed;left:20px;bottom:20px;z-index:60}
</style>
</head>
<body>
  <img id="photo" src="" alt="photo">
  <div id="mapContainer"><div id="map"></div></div>

  <div id="controlsTop"><button id="submit">Submit Guess (Space)</button></div>

  <div id="topInfo">
    <div id="roundDisplay">Round 1 / 5</div>
    <div id="timerDisplay">0:00.00</div>
  </div>

  <div id="result"></div>

  <div id="summaryOverlay">
    <div id="summaryText"></div>
    <div id="summaryButtons" style="margin-top:12px;"></div>
    <button id="restartBtn" style="display:none;">Play Again</button>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { saveScore } from './supabase.js';

(() => {
  const WORLD_MIN_X = -2000, WORLD_MAX_X = 2000;
  const WORLD_MIN_Z = -2000, WORLD_MAX_Z = 2000;
  let IMG_W = 4096, IMG_H = 4096;

  let places = [], current = 0, totalScore = 0, guess = null;
  let leafletMap = null, guessMarker = null, actualMarker = null;
  let totalElapsed = 0, roundStartTime = 0, timerInterval = null;
  const times = [];
  const selectedBiome = localStorage.getItem('selectedBiome') || 'Safe Shallows';
  const username = sessionStorage.getItem("username") || "Unknown";

  let mapLocked = false;
  let roundLocked = false;
  const MAX_ROUNDS = 5;
  const MAX_SCORE_ALLOWED = 25000;

  const timerDisplay = document.getElementById('timerDisplay');
  const roundDisplay = document.getElementById('roundDisplay');
  const summaryOverlay = document.getElementById('summaryOverlay');
  const summaryText = document.getElementById('summaryText');
  const summaryButtons = document.getElementById('summaryButtons');
  const result = document.getElementById('result');

  const backBtn = document.createElement("button");
  backBtn.textContent = "Back to Menu";
  backBtn.style.position = "fixed";
  backBtn.style.top = "15px";
  backBtn.style.right = "15px";
  backBtn.style.zIndex = "999";
  backBtn.onclick = () => window.location.href = "index.html";
  document.body.appendChild(backBtn);

  function formatTime(ms) {
    const totalSeconds = ms / 1000;
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = Math.floor(totalSeconds % 60);
    const hundredths = Math.floor((totalSeconds - Math.floor(totalSeconds)) * 100);
    return `${minutes}:${seconds.toString().padStart(2,'0')}.${hundredths.toString().padStart(2,'0')}`;
  }

  function startTimer() {
    clearInterval(timerInterval);
    roundStartTime = performance.now();
    timerInterval = setInterval(() => {
      const elapsed = performance.now() - roundStartTime;
      timerDisplay.textContent = formatTime(elapsed);
    }, 31);
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
      const roundElapsed = performance.now() - roundStartTime;
      totalElapsed += roundElapsed;
      times.push(roundElapsed);
      timerDisplay.textContent = formatTime(roundElapsed);
    }
  }

  function pixelToWorld(px, py) {
    const wx = (px / IMG_W) * (WORLD_MAX_X - WORLD_MIN_X) + WORLD_MIN_X;
    const wz = WORLD_MAX_Z - (py / IMG_H) * (WORLD_MAX_Z - WORLD_MIN_Z);
    return { x: wx, z: wz };
  }

  function worldToPixel(wx, wz) {
    const px = ((wx - WORLD_MIN_X) / (WORLD_MAX_X - WORLD_MIN_X)) * IMG_W;
    const py = ((WORLD_MAX_Z - wz) / (WORLD_MAX_Z - WORLD_MIN_Z)) * IMG_H;
    return [py, px];
  }

  function distanceWorld(a,b){return Math.hypot(a.x-b.x,a.z-b.z);}
  function scoreFromDistance(d){const max=5000;if(d<=10)return max;return Math.round(Math.max(0,max-(d-10)*1.25));}

  function disableMapInteractions(){try{leafletMap.dragging.disable();leafletMap.scrollWheelZoom.disable();leafletMap.doubleClickZoom.disable();leafletMap.boxZoom.disable();leafletMap.keyboard.disable();leafletMap.touchZoom.disable();}catch{}}
  function enableMapInteractions(){try{leafletMap.dragging.enable();leafletMap.scrollWheelZoom.enable();leafletMap.doubleClickZoom.enable();leafletMap.boxZoom.enable();leafletMap.keyboard.enable();leafletMap.touchZoom.enable();}catch{}}

  async function loadLocations(){
    const res = await fetch(`locations.json?cacheBust=${Date.now()}`);
    const data = await res.json();
    const biomeTarget = (selectedBiome || "").trim().toLowerCase();
    let source;
    if(biomeTarget==="entire map") source=data;
    else{
      const filtered=data.filter(i=>(i.biome||"").trim().toLowerCase()===biomeTarget);
      source=filtered.length?filtered:[];
    }
    if(!source.length){alert(`No locations found for "${selectedBiome}".`);return;}
    const shuffled=source.sort(()=>0.5-Math.random());
    places=shuffled.slice(0,Math.min(MAX_ROUNDS,shuffled.length)).map(i=>({...i,coords:{x:Number(i.coords.x),z:-Number(i.coords.z)}}));
    totalScore=0;totalElapsed=0;times.length=0;
    startRound(0);
  }

  function startRound(i){
    if(i>=MAX_ROUNDS||i>=places.length)return;
    current=i;
    roundDisplay.textContent=`Round ${i+1} / ${places.length}`;
    guess=null;result.textContent='';
    mapLocked=false;roundLocked=false;
    enableMapInteractions();
    if(leafletMap){
      if(guessMarker)leafletMap.removeLayer(guessMarker);
      if(actualMarker)leafletMap.removeLayer(actualMarker);
      leafletMap.flyTo([IMG_H/2,IMG_W/2], -3.3, {duration: 0.5}); // smooth fly to start
    }
    document.getElementById('photo').src=places[i].image;
    timerDisplay.textContent='0:00.00';
    startTimer();
  }

  function showSummaryRound(d,s){
    stopTimer();
    summaryOverlay.style.display='flex';
    summaryText.innerHTML=`<h2>Round ${current+1} Complete</h2><p>Distance: ${Math.round(d)} m</p><p>Score: ${s}</p><p>Loading next round...</p>`;
    roundLocked=true;
    summaryOverlay.onclick=null;
    document.removeEventListener('keydown',nextRoundKey);
    setTimeout(()=>{
      roundLocked=false;
      summaryText.innerHTML=`<h2>Round ${current+1} Complete</h2><p>Distance: ${Math.round(d)} m</p><p>Score: ${s}</p><p>Press Space or Click to Continue</p>`;
      document.addEventListener('keydown',nextRoundKey,{once:true});
      summaryOverlay.onclick=()=>{document.removeEventListener('keydown',nextRoundKey);nextRound();};
    },500);
  }

  function nextRoundKey(e){if(e.code==='Space'&&!roundLocked)nextRound();}
  function nextRound(){
    if(roundLocked)return;
    summaryOverlay.onclick=null;
    summaryOverlay.style.display='none';
    current++;
    if(current<places.length&&current<MAX_ROUNDS)startRound(current);
    else showFinalSummary();
  }

  async function showFinalSummary(){
    const totalTimeSec=Number((totalElapsed/1000).toFixed(2));
    summaryOverlay.style.display='flex';
    summaryText.innerHTML=`<h2>Game Over</h2><p>Username: ${username}</p><p>Biome: ${selectedBiome}</p><p>Total Score: ${totalScore}</p><p>Total Time: ${formatTime(totalElapsed)}</p>`;
    summaryButtons.innerHTML='';
    if(totalScore<=MAX_SCORE_ALLOWED){
      try{await saveScore(username,selectedBiome,totalScore,totalTimeSec);}catch(e){console.error("Error saving score:",e);}
    }else console.warn("Rejected invalid total score:",totalScore);
    const again=document.createElement('button');again.textContent='Play Again';again.onclick=()=>{summaryOverlay.style.display='none';loadLocations();};
    const dash=document.createElement('button');dash.textContent='Return to Dashboard';dash.onclick=()=>window.location.href='index.html';
    summaryButtons.appendChild(again);summaryButtons.appendChild(dash);
  }

  function submitGuess(){
    if(mapLocked||roundLocked)return;
    if(!guess){alert('Place a guess first!');return;}
    mapLocked=true;roundLocked=true;
    disableMapInteractions();
    const actual=places[current].coords;
    const d=distanceWorld(actual,guess);
    const s=scoreFromDistance(d);
    totalScore+=s;
    result.textContent=`Distance: ${Math.round(d)} m — Score: ${s}`;
    const [py,px]=worldToPixel(actual.x,actual.z);
    if(leafletMap){
      if(actualMarker)leafletMap.removeLayer(actualMarker);
      actualMarker=L.circleMarker([py,px],{radius:6,color:'red',fillColor:'red',fillOpacity:0.9}).addTo(leafletMap);
      leafletMap.flyTo([py,px], -0.75, {duration: 0.5, easeLinearity: 0.25}); // smooth zoom-in animation
    }
    setTimeout(()=>showSummaryRound(d,s),400);
  }

  function initMap(){
    leafletMap=L.map('map',{
      crs:L.CRS.Simple,
      minZoom:-3.3,
      maxZoom:3,
      zoomSnap:0.2,
      zoomDelta:0.2,
      wheelPxPerZoomLevel:150,
      zoomAnimation:true,
      zoomAnimationThreshold:5,
      attributionControl:false
    });
    const bounds=[[0,0],[IMG_H,IMG_W]];
    L.imageOverlay('map.png',bounds).addTo(leafletMap);
    leafletMap.fitBounds(bounds);
    leafletMap.setMaxBounds(bounds);
    leafletMap.on('click',e=>{
      if(mapLocked||roundLocked)return;
      const px=e.latlng.lng,py=e.latlng.lat;
      guess=pixelToWorld(px,py);
      if(guessMarker)leafletMap.removeLayer(guessMarker);
      guessMarker=L.circleMarker([py,px],{radius:6,color:'cyan',fillColor:'cyan',fillOpacity:0.9}).addTo(leafletMap);
    });
  }

  document.getElementById('submit').addEventListener('click',submitGuess);
  document.addEventListener('keydown',e=>{
    if(e.code==='Space'&&summaryOverlay.style.display==='none'&&!roundLocked)submitGuess();
  });

  const img=new Image();
  img.onload=()=>{IMG_W=img.width;IMG_H=img.height;initMap();loadLocations();};
  img.src='map.png';
})();
</script>
</body>
</html>
